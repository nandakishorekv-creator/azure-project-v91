trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: APP_NAME
    value: $(projectName)
  - name: RUNTIME_VERSION
    value: '4.9.0'
  - name: CLOUDHUB_TARGET
    value: 'us-east-2'  # Changed to region format, not "Cloudhub-US-East-2"
  - name: REPLICAS
    value: '1'
  - name: VCORES
    value: '0.1'

stages:
  #####################################################
  # BUILD STAGE
  #####################################################
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildJob
        displayName: 'Maven Build'
        steps:
          # Download settings.xml
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings'
            inputs:
              secureFile: 'settings.xml'
          
          # Install settings.xml
          - script: |
              echo "üì¶ Installing Maven settings..."
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              echo "‚úÖ Settings installed"
            displayName: 'Install Maven Settings'
          
          # Setup Java 17
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          # Cache Maven dependencies
          # - task: Cache@2
          #   displayName: 'Cache Maven Dependencies'
          #   inputs:
          #     key: 'maven | "$(Agent.OS)" | **/pom.xml'
          #     restoreKeys: |
          #       maven | "$(Agent.OS)"
          #       maven
          #     path: $(MAVEN_CACHE_FOLDER)
          
          # Maven Build
          - script: |
              echo "=========================================="
              echo " Building Mule Application"
              echo "=========================================="
              mvn clean package \
                -DskipTests \
                -Dsecure.key=mule \
                -Dmule.env=dev \
                -s ~/.m2/settings.xml
              
              if [ $? -eq 0 ]; then
                echo ""
                echo "‚úÖ BUILD SUCCESSFUL"
                echo ""
                echo "Artifact Details:"
                ls -lh target/*.jar
              else
                echo "‚ùå BUILD FAILED"
                exit 1
              fi
            displayName: 'Maven Package'
          
          # Copy artifacts
          - task: CopyFiles@2
            displayName: 'Copy Artifacts'
            inputs:
              Contents: '**/target/*.jar'
              TargetFolder: $(Build.ArtifactStagingDirectory)
              CleanTargetFolder: true
              flattenFolders: true
          
          # Publish artifacts
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'mule-app'
              publishLocation: 'pipeline'

  #####################################################
  # DEPLOY STAGE - CloudHub 2.0
  #####################################################
  - stage: Deploy
    displayName: 'Deploy to CloudHub 2.0'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployJob
        displayName: 'CloudHub 2.0 Deployment'
        steps:
          # Download artifacts
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifacts'
            inputs:
              artifactName: 'mule-app'
              targetPath: $(System.DefaultWorkingDirectory)/artifacts
          
          # Install Node.js
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '18.x'
          
          # Install Anypoint CLI
          - script: |
              echo "=========================================="
              echo " Installing Anypoint CLI"
              echo "=========================================="
              npm install -g anypoint-cli@latest
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ Anypoint CLI installed successfully"
                echo ""
                echo "üîç Checking Anypoint CLI version..."
                anypoint-cli --version
              else
                echo "‚ùå Failed to install Anypoint CLI"
                exit 1
              fi
            displayName: 'Install Anypoint CLI'
          
          # Login to Anypoint Platform
          - script: |
              echo "=========================================="
              echo " Logging into Anypoint Platform"
              echo "=========================================="
              
              anypoint-cli auth:login \
                --client-id "$(anypointClientId)" \
                --client-secret "$(anypointClientSecret)" \
                --organization "$(muleOrgId)"
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ Login successful"
              else
                echo "‚ùå Login failed"
                exit 1
              fi
            displayName: 'Login to Anypoint Platform'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
              muleOrgId: $(muleOrgId)
          
          # Deploy to CloudHub 2.0
          - script: |
              echo "=========================================="
              echo " CloudHub 2.0 Deployment"
              echo "=========================================="
              echo "Application: $(APP_NAME)"
              echo "Runtime: $(RUNTIME_VERSION)"
              echo "Region: $(CLOUDHUB_TARGET)"
              echo "Organization: $(muleOrg)"
              echo "Replicas: $(REPLICAS)"
              echo "vCores: $(VCORES)"
              echo ""
              
              # Find the JAR file
              JAR_FILE=$(find $(System.DefaultWorkingDirectory)/artifacts -name "*.jar" -type f | head -1)
              
              if [ -z "$JAR_FILE" ]; then
                echo "‚ùå ERROR: JAR file not found!"
                exit 1
              fi
              
              echo "üì¶ JAR File: $JAR_FILE"
              echo "üì¶ File Size: $(du -h "$JAR_FILE" | cut -f1)"
              echo ""
              
              # Deploy using Anypoint CLI
              echo "üöÄ Starting deployment..."
              echo ""
              
              # OPTION 1: For CloudHub 2.0 (Mule 4.3+ with replicas/vCores)
              # Note: This requires getting the deployment target ID first
              # You need to get the target ID using: anypoint-cli runtime-mgr cloudhub-application list-targets
              
              # OPTION 2: For CloudHub 1.0/2.0 (simpler approach)
              # Using cloudhub-application deploy with workers/workerSize
              
              # Let's use OPTION 2 which is more compatible
              anypoint-cli runtime-mgr cloudhub-application deploy \
                $(APP_NAME) \
                "$JAR_FILE" \
                --target $(CLOUDHUB_TARGET) \
                --runtime $(RUNTIME_VERSION) \
                --workers $(REPLICAS) \
                --workerSize "$(VCORES).0" \
                --property "mule.env=dev" \
                --property "secure.key=mule" \
                --auto-start true
              
              DEPLOY_EXIT_CODE=$?
              
              echo ""
              if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
                echo "=========================================="
                echo " ‚úÖ DEPLOYMENT SUCCESSFUL!"
                echo "=========================================="
                echo ""
                echo "Application: $(APP_NAME)"
                echo "Environment: Sandbox"
                echo "Region: $(CLOUDHUB_TARGET)"
                echo "Organization: $(muleOrg)"
                echo ""
                echo "üåê Check status at:"
                echo "   https://anypoint.mulesoft.com/cloudhub"
                echo ""
                
                # Display application status
                echo "üîç Checking application status..."
                sleep 10
                anypoint-cli runtime-mgr cloudhub-application describe $(APP_NAME) --json | jq -r '.status'
                
              else
                echo "=========================================="
                echo " ‚ùå DEPLOYMENT FAILED"
                echo "=========================================="
                echo ""
                echo "Exit Code: $DEPLOY_EXIT_CODE"
                echo ""
                echo "üí° Troubleshooting tips:"
                echo "1. Check if application name is unique"
                echo "2. Verify API credentials have proper permissions"
                echo "3. Check if target region is correct"
                echo "4. Verify runtime version is supported"
                exit 1
              fi
              
            displayName: 'Deploy to CloudHub 2.0'
            env:
              anypointClientId: $(anypointClientId)
              anypointClientSecret: $(anypointClientSecret)
              muleOrg: $(muleOrg)
              muleOrgId: $(muleOrgId)